---
- name: Test Mesh WebSocket access
  hosts: all
  gather_facts: true  # Ensure facts (including ansible_hostname) are gathered

  vars:
    mesh_ingress_0_url: "wss://mesh-ingress-0.cus-jemarmolm.aws.ansiblecloud.com"
    mesh_ingress_1_url: "wss://mesh-ingress-1.cus-jemarmolm.aws.ansiblecloud.com"
    cert_path: "/etc/receptor/tls/{{ ansible_hostname }}.ec2.internal.crt"
    key_path: "/etc/receptor/tls/{{ ansible_hostname }}.ec2.internal.key"
    ca_path: "/etc/receptor/tls/automation-controller-root-ca.crt"
    json_payload: '{"action": "helloWorld"}'

    # Define the common wscat command
    wscat_command: "wscat -c {{ item }} --cert {{ cert_path }} --key {{ key_path }} --ca {{ ca_path }} --no-check -w 1 -x '{{ json_payload }}'"

  tasks:
    - name: Check if Node.js is installed
      command: node -v
      register: node_check
      ignore_errors: true

    - name: Install Node.js if not installed
      dnf:
        name: nodejs
        state: present
      when: node_check.failed

    - name: Install wscat using npm if not installed
      command: npm install --prefix /home/{{ ansible_user }}/.local wscat
      when: node_check.rc == 0

    - name: Test connection to mesh-ingress-0
      shell: |
        echo "Running: {{ wscat_command }}"
        {{ wscat_command }}
      register: result_mesh_0
      changed_when: false
      failed_when: false
      loop:
        - "{{ mesh_ingress_0_url }}"

    - name: Assert successful connection to mesh-ingress-0
      assert:
        that:
          - "'NodeID' in result_mesh_0"
          - "'mesh-ingress-0' in result_mesh_0"

    - name: Test connection to mesh-ingress-1
      shell: |
        echo "Running: {{ wscat_command }}"
        {{ wscat_command }}
      register: result_mesh_1
      changed_when: false
      failed_when: false
      loop:
        - "{{ mesh_ingress_1_url }}"

    - name: Assert successful connection to mesh-ingress-1
      assert:
        that:
          - "'NodeID' in result_mesh_1.stdout"
          - "'mesh-ingress-1' in result_mesh_1.stdout"
...
